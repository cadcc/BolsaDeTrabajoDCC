{% extends "sub/main_column.html" %}
{% load staticfiles %}
{% block title %} Mis Advertencias {% endblock %}
{% block left_column_content %}
    {% include "sub/left-panel-user-profile.html" %}
{% endblock %}

{% block right_column_content %}
    {% csrf_token %}
    <h1>Mis Advertencias</h1>
    <div class="frame frame-light">
    {% for comment in user.getCommentsWithWarning %}
        <div class="panel panel-default" id="comment_{{ comment.id }}">
            <div class="panel-heading" style="padding-top: 1px; padding-bottom: 1px">
                <div>
                    <h4>
                        En
                        {% if comment.oferta %}
                            oferta <span class="text-capitalize">"{{ comment.oferta }}"</span>
                        {% else %}
                            empresa <span class="text-capitalize">"{{ comment.empresa }}"</span>
                        {% endif %}
                    </h4>
                </div>
            </div>
            <div class="panel-body">
                <div id="actual_comment_{{ comment.id }}">
                    <h4>{{ comment.comentario }}</h4>
                </div>
                <textarea id="textarea_{{ comment.id }}" name="edit_warning" class="form-control hidden">{{ comment.comentario }}</textarea>
            </div>
            <div class="panel-footer" style="padding-top: 5px; padding-bottom: 5px">
                <span class="text-info"><strong>Advertencia:</strong> {{ comment.getLastWarning.advertencia }}</span>
                <div class="pull-right">
                    <button id="edit_button_{{ comment.id }}"
                            data-idcomment="{{ comment.id }}"
                            type="button"
                            data-text="Editar"
                            class="btn btn-info btn-sm edit-button">Editar</button>
                    <button id="send_button_{{ comment.id }}"
                            data-idcomment="{{ comment.id }}"
                            type="button" data-text="Enviar"
                            data-type="{% if comment.oferta %}offer{% else %}company{% endif %}"
                            class="btn btn-info btn-sm send-button hidden">Enviar</button>
                    <button id="cancel_button_{{ comment.id }}"
                            data-idcomment="{{ comment.id }}"
                            class="btn btn-danger btn-sm hidden cancel-edit-button" type="button"><b>Cancelar</b></button>
                </div>
            </div>
        </div>
    {% empty %}
        <p>
            No tienes comentarios reportados
        </p>
    {% endfor %}
    </div>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        function wordLoading(word, idTag) {
            var i = 0;
            function dots() {
                var str = '';
                var j;
                for (j = 0; j <= i; j++) str += '.';
                i = (i + 1)%3;
                return str;
            }
            $(idTag).text(word);
            return setInterval(function () {
                $(idTag).text(word + dots())
            }, 500);
        }

        function sendInfo(url, data, done, button, idInterval) {
            var time = 5000;
            data.csrfmiddlewaretoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
            $.post(url, data).fail(function(msg) {
                console.log('Fallo el post a: ' + url);
                clearInterval(idInterval);
                setTimeout(function() {
                    $(button).text($(button).data('text'));
                }, 500);
                noty({text: 'Ocurrio un error al procesar la solicitud.', layout: 'topRight', type: 'error', timeout: time});
            }).done(function(msg) {
                console.log(msg);
                done();
                noty({text: msg.msg, layout: 'topRight', type: 'success', timeout: time});
            })
        }

        $('.edit-button').on('click', function(event) {
            var button = $(this);
            var id = button.data('idcomment');
            // efectos
            $('#textarea_' + id).removeClass('hidden');
            $('#actual_comment_' + id).addClass('hidden');
            $('#send_button_' + id).removeClass('hidden');
            $('#cancel_button_' + id).removeClass('hidden');
            $(button).addClass('hidden');
        });

        $('.send-button').on('click', function(event) {
            var button = $(this);
            var id = button.data('idcomment');
            var url = '/editar-comentario-por-advertencia/';
            var data = {
                'comment_id': id,
                'type': $(button).data('type'),
                'edit_text': $('#textarea_' + id).val()
            };
            var idInterval = wordLoading('Enviando', '#send_button_' + id);
            sendInfo(url, data, function() {
                $('#comment_' + id).hide('drop', {'direction': 'left'}, 500);
            }, button, idInterval);
        });

        $('.cancel-edit-button').click(function () {
            var button = $(this);
            var id = button.data('idcomment');
            var textarea = $('#textarea_' + id);
            var comment = $('#actual_comment_' + id);

            $(textarea).addClass('hidden');
            $(textarea).val($(comment).text().trim());
            $(comment).removeClass('hidden');
            $('#edit_button_' + id).removeClass('hidden');
            $('#send_button_' + id).addClass('hidden');
            $(button).addClass('hidden');
        });
    </script>
{% endblock %}